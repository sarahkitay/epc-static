<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <title>Parent Portal | EPC Client Management</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    .parent-view-header {
      background: rgba(11, 11, 11, 0.98);
      border-bottom: 1px solid var(--epc-line);
      padding: 8px 0;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .parent-view-header-content {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 40px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .parent-view-title {
      font-family: 'Playfair Display', serif;
      font-size: 14px;
      color: var(--epc-gold);
      letter-spacing: 0.05em;
      margin: 0;
      line-height: 1.2;
    }
    .parent-view-subtitle {
      font-size: 10px;
      color: var(--epc-ink-dim);
      margin-top: 2px;
      line-height: 1.2;
    }
    .parent-view-label {
      font-size: 11px;
      color: rgba(201, 178, 127, 0.6);
      margin-top: 4px;
      line-height: 1.2;
      font-weight: 400;
      letter-spacing: 0.03em;
      text-transform: none;
    }
    .parent-view-actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .parent-badge {
      display: inline-block;
      padding: 4px 8px;
      background: rgba(201, 178, 127, 0.15);
      border: 1px solid var(--epc-gold);
      border-radius: 3px;
      font-size: 9px;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--epc-gold);
    }
    .parent-view-header .btn-secondary {
      padding: 6px 12px;
      font-size: 11px;
    }
    .parent-view-content {
      max-width: 1400px;
      margin: 0 auto;
      padding: 40px;
    }
    .parent-info-card {
      background: rgba(11, 11, 11, 0.6);
      border: 1px solid var(--epc-line);
      border-radius: var(--radius);
      padding: 32px;
      margin-bottom: 32px;
    }
    .parent-info-card h3 {
      font-family: 'Playfair Display', serif;
      font-size: 20px;
      color: var(--epc-gold);
      margin-bottom: 20px;
      letter-spacing: 0.05em;
    }
    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
    }
    .info-item {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .info-label {
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--epc-ink-dim);
    }
    .info-value {
      font-size: 14px;
      color: var(--epc-ink);
    }
    .purchase-package-options {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }
    .package-option-btn {
      padding: 12px 20px;
      background: rgba(201,178,127,0.1);
      border: 1px solid var(--epc-line);
      border-radius: 6px;
      color: var(--epc-ink);
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .package-option-btn:hover {
      background: rgba(201,178,127,0.15);
      border-color: var(--epc-gold);
    }
    .package-option-btn.selected {
      border-color: var(--epc-gold);
      background: rgba(201,178,127,0.12);
    }
    #squareNotConfigured code {
      background: rgba(0,0,0,0.2);
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 12px;
    }
      @media (max-width: 768px) {
      .parent-view-header-content {
        padding: 0 20px;
        flex-direction: row;
        align-items: center;
        gap: 8px;
      }
      .parent-view-title {
        font-size: 12px;
      }
      .parent-view-subtitle {
        font-size: 9px;
      }
      .parent-view-label {
        font-size: 10px;
        margin-top: 3px;
      }
      .parent-view-content {
        padding: 20px;
      }
      .parent-info-card {
        padding: 24px;
      }
    }
  </style>
</head>
<body>
  <header class="parent-view-header">
    <div class="parent-view-header-content">
      <div>
        <h1 class="parent-view-title" id="clientNameTitle">Loading...</h1>
        <p class="parent-view-label">Parent View</p>
      </div>
      <div class="parent-view-actions">
        <button class="btn-secondary" onclick="window.location.href='parent-portal.html'">Logout</button>
      </div>
    </div>
  </header>

  <main>
    <div class="parent-view-content">
      <!-- Client Info Card -->
      <div class="parent-info-card">
        <h3>Client Information</h3>
        <div class="info-grid" id="clientInfoGrid">
          <!-- Populated by JavaScript -->
        </div>
      </div>

      <!-- Package & Sessions (read-only: remaining, used, total) -->
      <div class="parent-info-card" id="parentPackageCard" style="display: none;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h3 style="margin: 0;">Package & Sessions</h3>
          <span class="package-status-badge" id="parentPackageStatusBadge"></span>
        </div>
        <div class="info-grid" id="parentPackageGrid">
          <!-- Populated by JavaScript -->
        </div>
        <div style="display: flex; gap: 8px; margin-top: 16px; flex-wrap: wrap;">
          <button type="button" class="btn-primary" id="parentPurchasePackageBtn" onclick="document.getElementById('purchasePackageCard').scrollIntoView({ behavior: 'smooth', block: 'start' });">Purchase Package</button>
        </div>
      </div>

      <!-- Assessment -->
      <div class="parent-info-card" id="parentAssessmentCard" style="display: none;">
        <h3>Assessment</h3>
        <div id="parentAssessmentHistory">
          <p style="color: var(--epc-ink-dim);">Loading assessments...</p>
        </div>
      </div>

      <!-- Programs -->
      <div class="parent-info-card" id="parentProgramsCard" style="display: none;">
        <h3>Programs</h3>
        <div id="parentPrograms">
          <p style="color: var(--epc-ink-dim);">Loading programs...</p>
        </div>
      </div>

      <!-- Program Photos -->
      <div class="parent-info-card" id="parentPhotosCard" style="display: none;">
        <h3>Program Photos</h3>
        <div id="parentPhotos">
          <p style="color: var(--epc-ink-dim);">Loading photos...</p>
        </div>
      </div>

      <!-- Program Notes -->
      <div class="parent-info-card" id="parentNotesCard" style="display: none;">
        <h3>Program Notes</h3>
        <div id="parentNotes">
          <p style="color: var(--epc-ink-dim);">Loading notes...</p>
        </div>
      </div>

      <!-- Purchase a Package (Square ‚Äì outline until credentials added) -->
      <div class="parent-info-card" id="purchasePackageCard">
        <h3>Purchase a Package</h3>
        <p style="color: var(--epc-ink-dim); font-size: 13px; margin-bottom: 20px;">Buy session packages for your child. Payment is processed securely via Square.</p>
        <div class="purchase-package-options" id="packageOptions">
          <!-- Package buttons: name, sessions, amount (cents). Edit amounts when Square is set up. -->
          <button type="button" class="package-option-btn" data-name="5 Session Package" data-sessions="5" data-amount="25000" data-display="$250">5 Sessions ‚Äî $250</button>
          <button type="button" class="package-option-btn" data-name="10 Session Package" data-sessions="10" data-amount="45000" data-display="$450">10 Sessions ‚Äî $450</button>
          <button type="button" class="package-option-btn" data-name="20 Session Package" data-sessions="20" data-amount="80000" data-display="$800">20 Sessions ‚Äî $800</button>
        </div>
        <div id="packageSelectionSummary" style="display: none; margin: 20px 0; padding: 16px; background: rgba(201,178,127,0.08); border-radius: 6px;">
          <p style="margin: 0 0 8px 0;"><strong id="selectedPackageName"></strong></p>
          <p style="margin: 0; color: var(--epc-gold);" id="selectedPackageAmount"></p>
        </div>
        <div id="squareReadyIndicator" style="display: none; padding: 12px 16px; background: rgba(76,175,80,0.1); border: 1px solid rgba(76,175,80,0.3); border-radius: 6px; margin-bottom: 16px; color: #4CAF50; font-size: 13px;">
          <p style="margin: 0;">‚úì Square payment is ready. Select a package above to proceed.</p>
        </div>
        <div id="squarePaymentContainer" style="display: none;">
          <div id="square-card-container" style="min-height: 120px; margin-bottom: 16px;"></div>
          <button type="button" class="btn-primary" id="squarePayBtn" disabled>Pay with Square</button>
        </div>
        <div id="squareNotConfigured" style="display: none; padding: 20px; background: rgba(201,178,127,0.06); border: 1px dashed var(--epc-line); border-radius: 6px; color: var(--epc-ink-dim); font-size: 13px;">
          <p style="margin: 0;"><strong>Square payment</strong> will appear here once your Square account is connected. Add <code>SQUARE_APPLICATION_ID</code>, <code>SQUARE_LOCATION_ID</code>, and <code>SQUARE_ACCESS_TOKEN</code> in your project‚Äôs environment variables to enable payments.</p>
        </div>
        <div id="squarePaymentSuccess" style="display: none; padding: 20px; background: rgba(76,175,80,0.1); border: 1px solid rgba(76,175,80,0.3); border-radius: 6px; color: #4CAF50;">
          <p style="margin: 0;">Payment received. Your trainer will add the package to your account shortly.</p>
        </div>
      </div>
    </div>
  </main>

  <script src="db.js"></script>
  <script>
    let currentClientId = null;
    let currentClient = null;

    // Check parent session
    function checkParentSession() {
      const parentSession = sessionStorage.getItem('epc_secure_session_v1_parent');
      if (!parentSession) {
        window.location.href = 'parent-portal.html';
        return null;
      }

      try {
        const session = JSON.parse(parentSession);
        // Check if session is still valid (24 hours)
        if (Date.now() - session.timestamp > 24 * 60 * 60 * 1000) {
          sessionStorage.removeItem('epc_secure_session_v1_parent');
          window.location.href = 'parent-portal.html';
          return null;
        }
        return session;
      } catch (e) {
        sessionStorage.removeItem('epc_secure_session_v1_parent');
        window.location.href = 'parent-portal.html';
        return null;
      }
    }

    async function initParentView() {
      const session = checkParentSession();
      if (!session) return;

      // Get client ID from URL or session
      const urlParams = new URLSearchParams(window.location.search);
      currentClientId = parseInt(urlParams.get('id')) || session.clientId;

      if (!currentClientId) {
        alert('No client ID found. Redirecting to login.');
        window.location.href = 'parent-portal.html';
        return;
      }

      await initDB();

      // Load and display client data; stop if client not found (shows "log in again" inline)
      const loaded = await loadClientData();
      if (!loaded) return;
      
      // Check sharing settings and load only enabled sections
      // Show sections if not explicitly disabled (=== false)
      // Default behavior: show if staff has created data, hide if explicitly disabled
      const shareSettings = currentClient?.shareWithParent || {};
      
      console.log('Parent view - Share settings:', shareSettings);
      console.log('Parent view - Current client:', currentClient);
      
      // Assessments: show if not explicitly disabled
      if (shareSettings.assessments !== false) {
        const allAssessments = await getClientAssessments(currentClientId);
        const staffAssessments = allAssessments.filter(a => !a.createdBy || a.createdBy === 'staff');
        console.log('Parent view - Staff assessments found:', staffAssessments.length);
        if (staffAssessments.length > 0) {
          await loadAssessments();
          document.getElementById('parentAssessmentCard').style.display = 'block';
        }
      }
      
      // Programs: show if not explicitly disabled
      if (shareSettings.programs !== false) {
        const allPrograms = await getClientPrograms(currentClientId);
        const staffPrograms = allPrograms.filter(p => !p.createdBy || p.createdBy === 'staff');
        console.log('Parent view - Staff programs found:', staffPrograms.length);
        if (staffPrograms.length > 0) {
          await loadPrograms();
          document.getElementById('parentProgramsCard').style.display = 'block';
        }
      }
      
      // Photos: show if not explicitly disabled
      if (shareSettings.photos !== false) {
        const allPhotos = await getClientPhotos(currentClientId);
        const staffPhotos = allPhotos.filter(p => !p.createdBy || p.createdBy === 'staff');
        console.log('Parent view - Staff photos found:', staffPhotos.length);
        if (staffPhotos.length > 0) {
          await loadPhotos();
          document.getElementById('parentPhotosCard').style.display = 'block';
        }
      }
      
      // Notes: show if not explicitly disabled
      if (shareSettings.notes !== false) {
        const allNotes = await getClientNotes(currentClientId);
        const staffNotes = allNotes.filter(n => !n.createdBy || n.createdBy === 'staff');
        console.log('Parent view - Staff notes found:', staffNotes.length);
        if (staffNotes.length > 0) {
          await loadNotes();
          document.getElementById('parentNotesCard').style.display = 'block';
        }
      }
      // Always show package section for parents (they need to see remaining sessions and purchase option)
      const parentPackageCard = document.getElementById('parentPackageCard');
      if (parentPackageCard) {
        parentPackageCard.style.display = 'block';
      }
      
      initPurchasePackage();
    }

    // --- Purchase a Package (Square) ---
    let selectedPackage = null;
    let squareCfg = null;
    let squareCardInstance = null;
    let squareCardInitPromise = null;

    function loadSquareScript(useSandbox) {
      return new Promise((resolve, reject) => {
        if (window.Square) {
          resolve();
          return;
        }
        const s = document.createElement('script');
        // Production script (no sandbox)
        s.src = 'https://web.squarecdn.com/v1/square.js';
        s.async = true;
        s.onload = () => resolve();
        s.onerror = () => reject(new Error('Square SDK failed to load'));
        document.head.appendChild(s);
      });
    }

    async function initSquareCard() {
      if (!squareCfg || !squareCfg.applicationId || !squareCfg.locationId) {
        throw new Error('Square configuration missing');
      }
      if (squareCardInstance) return squareCardInstance;
      if (squareCardInitPromise) return squareCardInitPromise;
      squareCardInitPromise = (async () => {
        await loadSquareScript(!!squareCfg.useSandbox);
        if (!window.Square) throw new Error('Square SDK not available');
        const payments = window.Square.payments(squareCfg.applicationId, squareCfg.locationId);
        const card = await payments.card();
        const container = document.getElementById('square-card-container');
        if (!container) throw new Error('Card container not found');
        // Clear container before attaching
        container.innerHTML = '';
        await card.attach('#square-card-container');
        squareCardInstance = card;
        return card;
      })();
      return squareCardInitPromise;
    }

    async function initPurchasePackage() {
      const card = document.getElementById('purchasePackageCard');
      if (!card) return;

      const options = card.querySelectorAll('.package-option-btn');
      const summary = document.getElementById('packageSelectionSummary');
      const summaryName = document.getElementById('selectedPackageName');
      const summaryAmount = document.getElementById('selectedPackageAmount');
      const squarePaymentContainer = document.getElementById('squarePaymentContainer');
      const squareNotConfigured = document.getElementById('squareNotConfigured');
      const squarePaymentSuccess = document.getElementById('squarePaymentSuccess');
      const squareReadyIndicator = document.getElementById('squareReadyIndicator');
      const squarePayBtn = document.getElementById('squarePayBtn');

      // Check if Square is configured (GET /api/square)
      let squareConfigured = false;
      try {
        const r = await fetch('/api/square', { 
          cache: 'no-cache',
          headers: {
            'Cache-Control': 'no-cache, no-store, must-revalidate',
            'Pragma': 'no-cache'
          }
        });
        if (r.ok) {
          const cfg = await r.json();
          console.log('Square config response:', cfg);
          console.log('Square configured check:', cfg?.configured, 'appId:', !!cfg?.applicationId, 'locationId:', !!cfg?.locationId);
          
          // Check configured flag first, then fallback to checking for required fields
          if (cfg && cfg.configured === true) {
            squareCfg = { 
              applicationId: cfg.applicationId, 
              locationId: cfg.locationId, 
              useSandbox: cfg.useSandbox === true 
            };
            squareConfigured = true;
            console.log('Square is configured (via configured flag):', squareCfg);
          } else if (cfg && cfg.applicationId && cfg.locationId) {
            // Fallback: if API returns the IDs even without configured flag, use them
            squareCfg = { 
              applicationId: cfg.applicationId, 
              locationId: cfg.locationId, 
              useSandbox: cfg.useSandbox === true 
            };
            squareConfigured = true;
            console.log('Square is configured (via IDs):', squareCfg);
          } else {
            console.warn('Square not configured - response:', cfg);
            console.warn('Missing:', {
              configured: cfg?.configured,
              hasAppId: !!cfg?.applicationId,
              hasLocationId: !!cfg?.locationId,
              debug: cfg?.debug
            });
          }
        } else {
          const errorText = await r.text().catch(() => '');
          console.error('Square config API error:', r.status, errorText);
        }
      } catch (e) {
        console.error('Square config check failed:', e);
      }

      console.log('Square configured final:', squareConfigured);
      if (!squareConfigured) {
        if (squareNotConfigured) {
          squareNotConfigured.style.display = 'block';
          console.log('Showing Square not configured message');
        }
        if (squareReadyIndicator) squareReadyIndicator.style.display = 'none';
        if (squarePaymentContainer) squarePaymentContainer.style.display = 'none';
      } else {
        if (squareNotConfigured) {
          squareNotConfigured.style.display = 'none';
          console.log('Hiding Square not configured message');
        }
        if (squareReadyIndicator) {
          squareReadyIndicator.style.display = 'block';
          console.log('Showing Square ready indicator');
        }
        console.log('Square is ready - payment form will show when package is selected');
      }

      options.forEach((btn) => {
        btn.addEventListener('click', async () => {
          options.forEach((b) => b.classList.remove('selected'));
          btn.classList.add('selected');
          selectedPackage = {
            name: btn.dataset.name,
            sessions: parseInt(btn.dataset.sessions, 10),
            amount: parseInt(btn.dataset.amount, 10),
            display: btn.dataset.display
          };
          if (summary && summaryName && summaryAmount) {
            summary.style.display = 'block';
            summaryName.textContent = selectedPackage.name;
            summaryAmount.textContent = selectedPackage.display;
          }
          if (squareConfigured && squarePaymentContainer) {
            squarePaymentContainer.style.display = 'block';
            if (squarePaymentSuccess) squarePaymentSuccess.style.display = 'none';
            if (squareNotConfigured) squareNotConfigured.style.display = 'none';
            if (squareReadyIndicator) squareReadyIndicator.style.display = 'none';
            if (squarePayBtn) squarePayBtn.disabled = true;
            // Reset card instance if switching packages
            squareCardInstance = null;
            squareCardInitPromise = null;
            const cardContainer = document.getElementById('square-card-container');
            if (cardContainer) cardContainer.innerHTML = '';
            try {
              await initSquareCard();
              if (squarePayBtn) squarePayBtn.disabled = false;
            } catch (e) {
              console.error('Square card init failed:', e);
              if (squarePayBtn) squarePayBtn.disabled = false;
              // Show error message
              if (squareNotConfigured) {
                squareNotConfigured.style.display = 'block';
                squareNotConfigured.innerHTML = '<p style="margin: 0; color: #d32f2f;">Failed to load payment form: ' + e.message + '. Please refresh the page.</p>';
              }
            }
          } else if (!squareConfigured) {
            // Re-check configuration when package is selected
            try {
              const r = await fetch('/api/square');
              if (r.ok) {
                const cfg = await r.json();
                if (cfg && (cfg.configured === true || (cfg.applicationId && cfg.locationId))) {
                  squareCfg = { 
                    applicationId: cfg.applicationId, 
                    locationId: cfg.locationId, 
                    useSandbox: cfg.useSandbox === true 
                  };
                  squareConfigured = true;
                  if (squareNotConfigured) squareNotConfigured.style.display = 'none';
                  if (squareReadyIndicator) squareReadyIndicator.style.display = 'none';
                  if (squarePaymentContainer) {
                    squarePaymentContainer.style.display = 'block';
                    if (squarePayBtn) squarePayBtn.disabled = true;
                    await initSquareCard();
                    if (squarePayBtn) squarePayBtn.disabled = false;
                  }
                }
              }
            } catch (e) {
              console.error('Square re-check failed:', e);
            }
          }
        });
      });

      if (squarePayBtn && squareConfigured) {
        squarePayBtn.addEventListener('click', async () => {
          if (!selectedPackage || !squareCardInstance || !currentClientId) return;
          squarePayBtn.disabled = true;
          try {
            const amountStr = (selectedPackage.amount / 100).toFixed(2);
            const verificationDetails = {
              amount: amountStr,
              currencyCode: 'USD',
              intent: 'CHARGE',
              customerInitiated: true,
              sellerKeyedIn: false,
              billingContact: {
                givenName: (currentClient && currentClient.name) ? currentClient.name.split(' ')[0] : 'Parent',
                familyName: (currentClient && currentClient.name) ? currentClient.name.split(' ').slice(1).join(' ') || 'Guardian' : 'Guardian',
                countryCode: 'US'
              }
            };
            const tokenResult = await squareCardInstance.tokenize(verificationDetails);
            if (tokenResult.status !== 'OK') {
              throw new Error(tokenResult.errors ? JSON.stringify(tokenResult.errors) : 'Card tokenization failed');
            }
            const sourceId = tokenResult.token;
            const body = {
              sourceId,
              amount: selectedPackage.amount,
              idempotencyKey: window.crypto && window.crypto.randomUUID ? window.crypto.randomUUID() : 'pk-' + Date.now() + '-' + Math.random().toString(36).slice(2),
              clientId: currentClientId,
              clientName: (currentClient && currentClient.name) || '',
              packageName: selectedPackage.name,
              sessionCount: selectedPackage.sessions
            };
            const payRes = await fetch('/api/square', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(body)
            });
            const data = payRes.ok ? await payRes.json() : await payRes.json().catch(() => ({}));
            if (!payRes.ok) {
              throw new Error(data.error || data.message || 'Payment failed');
            }
            // Payment successful - clear form and show success
            if (squarePaymentContainer) squarePaymentContainer.style.display = 'none';
            if (summary) summary.style.display = 'none';
            options.forEach((b) => b.classList.remove('selected'));
            selectedPackage = null;
            // Clear card instance so it can be re-initialized for next purchase
            squareCardInstance = null;
            squareCardInitPromise = null;
            const cardContainer = document.getElementById('square-card-container');
            if (cardContainer) cardContainer.innerHTML = '';
            
            if (squarePaymentSuccess) squarePaymentSuccess.style.display = 'block';
            
            // Reload client data to show updated package info
            setTimeout(async () => {
              await loadClientData();
            }, 1000);
          } catch (e) {
            console.error('Square payment error:', e);
            const errorMsg = e.message || 'Payment could not be completed. Please try again.';
            alert(errorMsg);
            // Keep form visible so user can retry
          } finally {
            squarePayBtn.disabled = false;
          }
        });
      }
    }

    function showSessionExpiredState() {
      sessionStorage.removeItem('epc_secure_session_v1_parent');
      const main = document.querySelector('.parent-view-content');
      if (main) {
        main.innerHTML = `
          <div class="parent-info-card" style="text-align: center; max-width: 480px; margin: 40px auto;">
            <h3 style="margin-bottom: 16px;">Session expired or client data unavailable</h3>
            <p style="color: var(--epc-ink-dim); margin-bottom: 24px;">This device may not have the client data, or your session has expired. Please log in again from the device where you registered.</p>
            <a href="parent-portal.html" class="btn-primary" style="display: inline-block; text-decoration: none; text-align: center;">Log in again</a>
          </div>
        `;
      }
    }

    async function loadClientData() {
      try {
        currentClient = await getClient(currentClientId);
        if (!currentClient) {
          showSessionExpiredState();
          return false;
        }

        document.getElementById('clientNameTitle').textContent = currentClient.name;

        const infoGrid = document.getElementById('clientInfoGrid');
        infoGrid.innerHTML = `
          <div class="info-item">
            <span class="info-label">Age</span>
            <span class="info-value">${currentClient.age || 'N/A'}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Primary Trainer</span>
            <span class="info-value">${currentClient.primaryTrainer || 'N/A'}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Parent Contact</span>
            <span class="info-value">${currentClient.parentContact || 'N/A'}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Emergency Contact</span>
            <span class="info-value">${currentClient.emergencyContact || 'N/A'}</span>
          </div>
        `;

        const total = currentClient.packageTotalSessions != null ? currentClient.packageTotalSessions : null;
        const used = currentClient.packageUsedSessions != null ? currentClient.packageUsedSessions : 0;
        const remaining = currentClient.packageRemainingSessions != null ? currentClient.packageRemainingSessions : (total != null ? total - used : null);
        const packageGrid = document.getElementById('parentPackageGrid');
        const statusBadge = document.getElementById('parentPackageStatusBadge');
        
        if (packageGrid) {
          packageGrid.innerHTML = `
            <div class="info-item">
              <span class="info-label">Package</span>
              <span class="info-value">${currentClient.packageName || 'Not set'}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Sessions Remaining</span>
              <span class="info-value">${remaining != null ? remaining : '--'}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Total Sessions</span>
              <span class="info-value">${total != null ? total : '--'}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Sessions Used</span>
              <span class="info-value">${used}</span>
            </div>
          `;
        }
        
        // Update status badge
        if (statusBadge) {
          if (remaining !== null && remaining !== undefined) {
            if (remaining === 0) {
              statusBadge.textContent = '‚ùå OUT';
              statusBadge.className = 'package-status-badge status-out';
            } else if (remaining <= 3) {
              statusBadge.textContent = '‚ö†Ô∏è LOW';
              statusBadge.className = 'package-status-badge status-low';
            } else {
              statusBadge.textContent = '‚úì OK';
              statusBadge.className = 'package-status-badge status-ok';
            }
          } else {
            // No package data - hide badge
            statusBadge.textContent = '';
            statusBadge.className = 'package-status-badge';
          }
        }

        return true;
      } catch (error) {
        console.error('Error loading client:', error);
        showSessionExpiredState();
        return false;
      }
    }

    async function loadAssessments() {
      try {
        const allAssessments = await getClientAssessments(currentClientId);
        // Filter to only show staff-created assessments (createdBy === 'staff' or undefined for backward compatibility)
        const assessments = allAssessments.filter(a => !a.createdBy || a.createdBy === 'staff');
        const container = document.getElementById('parentAssessmentHistory');

        if (!assessments || assessments.length === 0) {
          container.innerHTML = '<p style="color: var(--epc-ink-dim);">No assessments recorded yet.</p>';
          return;
        }

        container.innerHTML = assessments.map((assessment, idx) => {
          const date = new Date(assessment.date).toLocaleDateString();
          return `
            <div style="border-bottom: 1px solid var(--epc-line); padding: 20px 0; ${idx === assessments.length - 1 ? 'border-bottom: none;' : ''}">
              <h4 style="color: var(--epc-gold); margin-bottom: 12px;">Assessment ${idx + 1} - ${date}</h4>
              ${(assessment.pedicsPdf || assessment.overallAssessmentPdf) ? `
                <div style="margin-bottom: 16px; display: flex; gap: 12px; flex-wrap: wrap;">
                  ${assessment.pedicsPdf ? `<a href="${assessment.pedicsPdf}" target="_blank" style="display: inline-block; padding: 8px 16px; background: rgba(201,178,127,0.1); border: 1px solid var(--epc-gold); border-radius: 4px; color: var(--epc-gold); text-decoration: none; font-size: 12px;">üìÑ View PEDICS PDF</a>` : ''}
                  ${assessment.overallAssessmentPdf ? `<a href="${assessment.overallAssessmentPdf}" target="_blank" style="display: inline-block; padding: 8px 16px; background: rgba(201,178,127,0.1); border: 1px solid var(--epc-gold); border-radius: 4px; color: var(--epc-gold); text-decoration: none; font-size: 12px;">üìÑ View Overall Assessment PDF</a>` : ''}
                </div>
              ` : ''}
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; font-size: 13px;">
                ${assessment.proteusScore ? `<div><strong>Proteus Score:</strong> ${assessment.proteusScore}</div>` : ''}
                ${assessment.powerOutput ? `<div><strong>Power Output:</strong> ${assessment.powerOutput}${assessment.powerOutputNotes ? ` (${assessment.powerOutputNotes})` : ''}</div>` : ''}
                ${assessment.speed ? `<div><strong>Speed:</strong> ${assessment.speed}${assessment.speedNotes ? ` (${assessment.speedNotes})` : ''}</div>` : ''}
                ${assessment.squatOverallScore ? `<div><strong>Overhead Squat Score:</strong> ${assessment.squatOverallScore}${assessment.squatNotes ? ` (${assessment.squatNotes})` : ''}</div>` : ''}
                ${(assessment.shoulderRightScore || assessment.shoulderLeftScore) ? `<div><strong>Shoulder Mobility:</strong> R: ${assessment.shoulderRightScore || 'N/A'}, L: ${assessment.shoulderLeftScore || 'N/A'}${assessment.shoulderNotes ? ` (${assessment.shoulderNotes})` : ''}</div>` : ''}
                ${assessment.hamstringScore ? `<div><strong>Hamstring Mobility:</strong> ${assessment.hamstringScore}${assessment.hamstringNotes ? ` (${assessment.hamstringNotes})` : ''}</div>` : ''}
                ${assessment.pushupScore ? `<div><strong>Push-up Score:</strong> ${assessment.pushupScore}${assessment.pushupNotes ? ` (${assessment.pushupNotes})` : ''}</div>` : ''}
                ${assessment.pedicsReview ? `<div><strong>PEDICS Review:</strong> ${assessment.pedicsReview}</div>` : ''}
              </div>
            </div>
          `;
        }).join('');
      } catch (error) {
        console.error('Error loading assessments:', error);
        document.getElementById('parentAssessmentHistory').innerHTML = '<p style="color: #d32f2f;">Error loading assessments.</p>';
      }
    }

    async function loadPrograms() {
      try {
        const allPrograms = await getClientPrograms(currentClientId);
        // Filter to only show staff-created programs (createdBy === 'staff' or undefined for backward compatibility)
        const programs = allPrograms.filter(p => !p.createdBy || p.createdBy === 'staff');
        const container = document.getElementById('parentPrograms');

        if (!programs || programs.length === 0) {
          container.innerHTML = '<p style="color: var(--epc-ink-dim);">No programs created yet.</p>';
          return;
        }

        container.innerHTML = programs.map((program, idx) => {
          const date = new Date(program.createdAt).toLocaleDateString();
          const exercises = program.exercises || [];
          return `
            <div style="border-bottom: 1px solid var(--epc-line); padding: 20px 0; ${idx === programs.length - 1 ? 'border-bottom: none;' : ''}">
              <h4 style="color: var(--epc-gold); margin-bottom: 12px;">Week ${program.week} - ${date}</h4>
              ${exercises.length > 0 ? `
                <ul style="list-style: none; padding: 0; margin: 0;">
                  ${exercises.map(ex => `<li style="padding: 8px 0; border-bottom: 1px solid rgba(201, 178, 127, 0.1);">
                    <strong>${ex.name}</strong>${ex.sets ? ` - ${ex.sets} sets x ${ex.reps || 'N/A'} reps` : ''}${ex.notes ? `<br><small style="color: var(--epc-ink-dim);">${ex.notes}</small>` : ''}
                  </li>`).join('')}
                </ul>
              ` : '<p style="color: var(--epc-ink-dim);">No exercises in this program.</p>'}
            </div>
          `;
        }).join('');
      } catch (error) {
        console.error('Error loading programs:', error);
        document.getElementById('parentPrograms').innerHTML = '<p style="color: #d32f2f;">Error loading programs.</p>';
      }
    }

    async function loadNotes() {
      try {
        const allNotes = await getClientNotes(currentClientId);
        // Filter to only show staff-created notes (createdBy === 'staff' or undefined for backward compatibility)
        const notes = allNotes.filter(n => !n.createdBy || n.createdBy === 'staff');
        const container = document.getElementById('parentNotes');

        if (!notes || notes.length === 0) {
          container.innerHTML = '<p style="color: var(--epc-ink-dim);">No program notes recorded yet.</p>';
          return;
        }

        container.innerHTML = notes.map((note, idx) => {
          const date = new Date(note.date).toLocaleDateString();
          return `
            <div style="border-bottom: 1px solid var(--epc-line); padding: 20px 0; ${idx === notes.length - 1 ? 'border-bottom: none;' : ''}">
              <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                <strong style="color: var(--epc-gold);">${date}</strong>
              </div>
              <p style="color: var(--epc-ink); line-height: 1.6; margin: 0;">${note.content || note.note}</p>
            </div>
          `;
        }).join('');
      } catch (error) {
        console.error('Error loading notes:', error);
        document.getElementById('parentNotes').innerHTML = '<p style="color: #d32f2f;">Error loading notes.</p>';
      }
    }

    async function loadPhotos() {
      try {
        const allPhotos = await getClientPhotos(currentClientId);
        // Filter to only show staff-created photos (createdBy === 'staff' or undefined for backward compatibility)
        const photos = allPhotos.filter(p => !p.createdBy || p.createdBy === 'staff');
        const container = document.getElementById('parentPhotos');

        if (!photos || photos.length === 0) {
          container.innerHTML = '<p style="color: var(--epc-ink-dim);">No program photos uploaded yet.</p>';
          return;
        }

        container.innerHTML = photos.map((photo, idx) => {
          const date = new Date(photo.uploadedAt).toLocaleDateString();
          return `
            <div style="border-bottom: 1px solid var(--epc-line); padding: 20px 0; ${idx === photos.length - 1 ? 'border-bottom: none;' : ''}">
              <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                <strong style="color: var(--epc-gold);">${date}</strong>
              </div>
              ${photo.imageUrl ? `
                <img src="${photo.imageUrl}" alt="Progress photo" style="max-width: 100%; border-radius: 6px; margin-top: 12px;" />
              ` : ''}
              ${photo.notes ? `<p style="color: var(--epc-ink); line-height: 1.6; margin-top: 12px; margin-bottom: 0;">${photo.notes}</p>` : ''}
            </div>
          `;
        }).join('');
      } catch (error) {
        console.error('Error loading photos:', error);
        document.getElementById('parentPhotos').innerHTML = '<p style="color: #d32f2f;">Error loading photos.</p>';
      }
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initParentView);
    } else {
      initParentView();
    }
  </script>
</body>
</html>
