<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <title>Parent Portal | EPC Client Management</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    .parent-view-header {
      background: rgba(11, 11, 11, 0.98);
      border-bottom: 1px solid var(--epc-line);
      padding: 8px 0;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .parent-view-header-content {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 40px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .parent-view-title {
      font-family: 'Playfair Display', serif;
      font-size: 14px;
      color: var(--epc-gold);
      letter-spacing: 0.05em;
      margin: 0;
      line-height: 1.2;
    }
    .parent-view-subtitle {
      font-size: 10px;
      color: var(--epc-ink-dim);
      margin-top: 2px;
      line-height: 1.2;
    }
    .parent-view-actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .parent-badge {
      display: inline-block;
      padding: 4px 8px;
      background: rgba(201, 178, 127, 0.15);
      border: 1px solid var(--epc-gold);
      border-radius: 3px;
      font-size: 9px;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--epc-gold);
    }
    .parent-view-header .btn-secondary {
      padding: 6px 12px;
      font-size: 11px;
    }
    .parent-view-content {
      max-width: 1400px;
      margin: 0 auto;
      padding: 40px;
    }
    .parent-info-card {
      background: rgba(11, 11, 11, 0.6);
      border: 1px solid var(--epc-line);
      border-radius: var(--radius);
      padding: 32px;
      margin-bottom: 32px;
    }
    .parent-info-card h3 {
      font-family: 'Playfair Display', serif;
      font-size: 20px;
      color: var(--epc-gold);
      margin-bottom: 20px;
      letter-spacing: 0.05em;
    }
    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
    }
    .info-item {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .info-label {
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--epc-ink-dim);
    }
    .info-value {
      font-size: 14px;
      color: var(--epc-ink);
    }
    .read-only-notice {
      background: rgba(201, 178, 127, 0.08);
      border-bottom: 1px solid rgba(201, 178, 127, 0.2);
      padding: 8px 40px;
      margin: 0;
      font-size: 11px;
      color: var(--epc-ink-dim);
      text-align: center;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      position: sticky;
      top: 0;
      z-index: 99;
    }
    .read-only-notice p {
      margin: 0;
      font-size: 11px;
      color: var(--epc-ink-dim);
      line-height: 1.4;
    }
    .purchase-package-options {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }
    .package-option-btn {
      padding: 12px 20px;
      background: rgba(201,178,127,0.1);
      border: 1px solid var(--epc-line);
      border-radius: 6px;
      color: var(--epc-ink);
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .package-option-btn:hover {
      background: rgba(201,178,127,0.15);
      border-color: var(--epc-gold);
    }
    .package-option-btn.selected {
      border-color: var(--epc-gold);
      background: rgba(201,178,127,0.12);
    }
    #squareNotConfigured code {
      background: rgba(0,0,0,0.2);
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 12px;
    }
      @media (max-width: 768px) {
      .parent-view-header-content {
        padding: 0 20px;
        flex-direction: row;
        align-items: center;
        gap: 8px;
      }
      .parent-view-title {
        font-size: 12px;
      }
      .parent-view-subtitle {
        font-size: 9px;
      }
      .parent-badge {
        font-size: 8px;
        padding: 3px 6px;
      }
      .parent-view-content {
        padding: 20px;
      }
      .parent-info-card {
        padding: 24px;
      }
    }
  </style>
</head>
<body>
  <header class="parent-view-header">
    <div class="parent-view-header-content">
      <div>
        <h1 class="parent-view-title" id="clientNameTitle">Loading...</h1>
        <p class="parent-view-subtitle">Parent Portal - Read Only Access</p>
      </div>
      <div class="parent-view-actions">
        <span class="parent-badge">Parent View</span>
        <button class="btn-secondary" onclick="window.location.href='parent-portal.html'">Logout</button>
      </div>
    </div>
  </header>

  <main>
    <div class="parent-view-content">
      <!-- Read-Only Notice -->
      <div class="read-only-notice">
        <p>Read-only view. Contact your trainer to make changes.</p>
      </div>

      <!-- Client Info Card -->
      <div class="parent-info-card">
        <h3>Client Information</h3>
        <div class="info-grid" id="clientInfoGrid">
          <!-- Populated by JavaScript -->
        </div>
      </div>

      <!-- Package & Sessions (read-only: remaining, used, total) -->
      <div class="parent-info-card" id="parentPackageCard" style="display: none;">
        <h3>Package & Sessions</h3>
        <div class="info-grid" id="parentPackageGrid">
          <!-- Populated by JavaScript -->
        </div>
      </div>

      <!-- Assessment History -->
      <div class="parent-info-card" id="parentAssessmentCard" style="display: none;">
        <h3>Assessment History</h3>
        <div id="parentAssessmentHistory">
          <p style="color: var(--epc-ink-dim);">Loading assessments...</p>
        </div>
      </div>

      <!-- Programs -->
      <div class="parent-info-card" id="parentProgramsCard" style="display: none;">
        <h3>Training Programs</h3>
        <div id="parentPrograms">
          <p style="color: var(--epc-ink-dim);">Loading programs...</p>
        </div>
      </div>

      <!-- Progress Notes -->
      <div class="parent-info-card" id="parentNotesCard" style="display: none;">
        <h3>Progress Notes</h3>
        <div id="parentNotes">
          <p style="color: var(--epc-ink-dim);">Loading notes...</p>
        </div>
      </div>

      <!-- PT Coordination Notes -->
      <div class="parent-info-card" id="parentPTNotesCard" style="display: none;">
        <h3>PT Coordination Notes</h3>
        <div id="parentPTNotes">
          <p style="color: var(--epc-ink-dim);">Loading PT notes...</p>
        </div>
      </div>

      <!-- Purchase a Package (Square – outline until credentials added) -->
      <div class="parent-info-card" id="purchasePackageCard">
        <h3>Purchase a Package</h3>
        <p style="color: var(--epc-ink-dim); font-size: 13px; margin-bottom: 20px;">Buy session packages for your child. Payment is processed securely via Square.</p>
        <div class="purchase-package-options" id="packageOptions">
          <!-- Package buttons: name, sessions, amount (cents). Edit amounts when Square is set up. -->
          <button type="button" class="package-option-btn" data-name="5 Session Package" data-sessions="5" data-amount="25000" data-display="$250">5 Sessions — $250</button>
          <button type="button" class="package-option-btn" data-name="10 Session Package" data-sessions="10" data-amount="45000" data-display="$450">10 Sessions — $450</button>
          <button type="button" class="package-option-btn" data-name="20 Session Package" data-sessions="20" data-amount="80000" data-display="$800">20 Sessions — $800</button>
        </div>
        <div id="packageSelectionSummary" style="display: none; margin: 20px 0; padding: 16px; background: rgba(201,178,127,0.08); border-radius: 6px;">
          <p style="margin: 0 0 8px 0;"><strong id="selectedPackageName"></strong></p>
          <p style="margin: 0; color: var(--epc-gold);" id="selectedPackageAmount"></p>
        </div>
        <div id="squarePaymentContainer" style="display: none;">
          <div id="square-card-container" style="min-height: 120px; margin-bottom: 16px;"></div>
          <button type="button" class="btn-primary" id="squarePayBtn" disabled>Pay with Square</button>
        </div>
        <div id="squareNotConfigured" style="padding: 20px; background: rgba(201,178,127,0.06); border: 1px dashed var(--epc-line); border-radius: 6px; color: var(--epc-ink-dim); font-size: 13px;">
          <p style="margin: 0;"><strong>Square payment</strong> will appear here once your Square account is connected. Add <code>SQUARE_APPLICATION_ID</code>, <code>SQUARE_LOCATION_ID</code>, and <code>SQUARE_ACCESS_TOKEN</code> in your project’s environment variables to enable payments.</p>
        </div>
        <div id="squarePaymentSuccess" style="display: none; padding: 20px; background: rgba(76,175,80,0.1); border: 1px solid rgba(76,175,80,0.3); border-radius: 6px; color: #4CAF50;">
          <p style="margin: 0;">Payment received. Your trainer will add the package to your account shortly.</p>
        </div>
      </div>
    </div>
  </main>

  <script src="db.js"></script>
  <script>
    let currentClientId = null;
    let currentClient = null;

    // Check parent session
    function checkParentSession() {
      const parentSession = sessionStorage.getItem('epc_secure_session_v1_parent');
      if (!parentSession) {
        window.location.href = 'parent-portal.html';
        return null;
      }

      try {
        const session = JSON.parse(parentSession);
        // Check if session is still valid (24 hours)
        if (Date.now() - session.timestamp > 24 * 60 * 60 * 1000) {
          sessionStorage.removeItem('epc_secure_session_v1_parent');
          window.location.href = 'parent-portal.html';
          return null;
        }
        return session;
      } catch (e) {
        sessionStorage.removeItem('epc_secure_session_v1_parent');
        window.location.href = 'parent-portal.html';
        return null;
      }
    }

    async function initParentView() {
      const session = checkParentSession();
      if (!session) return;

      // Get client ID from URL or session
      const urlParams = new URLSearchParams(window.location.search);
      currentClientId = parseInt(urlParams.get('id')) || session.clientId;

      if (!currentClientId) {
        alert('No client ID found. Redirecting to login.');
        window.location.href = 'parent-portal.html';
        return;
      }

      await initDB();

      // Load and display client data; stop if client not found (shows "log in again" inline)
      const loaded = await loadClientData();
      if (!loaded) return;
      
      // Check sharing settings and load only enabled sections
      const shareSettings = currentClient?.shareWithParent || {
        assessments: true,
        programs: true,
        notes: true,
        ptNotes: false,
        packageInfo: true
      };
      
      if (shareSettings.assessments !== false) {
        await loadAssessments();
        document.getElementById('parentAssessmentCard').style.display = 'block';
      }
      if (shareSettings.programs !== false) {
        await loadPrograms();
        document.getElementById('parentProgramsCard').style.display = 'block';
      }
      if (shareSettings.notes !== false) {
        await loadNotes();
        document.getElementById('parentNotesCard').style.display = 'block';
      }
      if (shareSettings.ptNotes === true) {
        await loadPTNotes();
        document.getElementById('parentPTNotesCard').style.display = 'block';
      }
      if (shareSettings.packageInfo !== false) {
        document.getElementById('parentPackageCard').style.display = 'block';
      }
      
      initPurchasePackage();
    }

    // --- Purchase a Package (Square) ---
    let selectedPackage = null;
    let squareCfg = null;
    let squareCardInstance = null;
    let squareCardInitPromise = null;

    function loadSquareScript(useSandbox) {
      return new Promise((resolve, reject) => {
        if (window.Square) {
          resolve();
          return;
        }
        const s = document.createElement('script');
        // Production script (no sandbox)
        s.src = 'https://web.squarecdn.com/v1/square.js';
        s.async = true;
        s.onload = () => resolve();
        s.onerror = () => reject(new Error('Square SDK failed to load'));
        document.head.appendChild(s);
      });
    }

    async function initSquareCard() {
      if (!squareCfg || !squareCfg.applicationId || !squareCfg.locationId) return null;
      if (squareCardInstance) return squareCardInstance;
      if (squareCardInitPromise) return squareCardInitPromise;
      squareCardInitPromise = (async () => {
        await loadSquareScript(!!squareCfg.useSandbox);
        if (!window.Square) throw new Error('Square SDK not available');
        const payments = window.Square.payments(squareCfg.applicationId, squareCfg.locationId);
        const card = await payments.card();
        const container = document.getElementById('square-card-container');
        if (container && container.innerHTML === '') await card.attach('#square-card-container');
        squareCardInstance = card;
        return card;
      })();
      return squareCardInitPromise;
    }

    async function initPurchasePackage() {
      const card = document.getElementById('purchasePackageCard');
      if (!card) return;

      const options = card.querySelectorAll('.package-option-btn');
      const summary = document.getElementById('packageSelectionSummary');
      const summaryName = document.getElementById('selectedPackageName');
      const summaryAmount = document.getElementById('selectedPackageAmount');
      const squarePaymentContainer = document.getElementById('squarePaymentContainer');
      const squareNotConfigured = document.getElementById('squareNotConfigured');
      const squarePaymentSuccess = document.getElementById('squarePaymentSuccess');
      const squarePayBtn = document.getElementById('squarePayBtn');

      // Check if Square is configured (GET /api/square)
      let squareConfigured = false;
      try {
        const r = await fetch('/api/square');
        if (r.ok) {
          const cfg = await r.json();
          console.log('Square config response:', cfg);
          if (cfg && (cfg.configured === true || (cfg.applicationId && cfg.locationId))) {
            squareCfg = { 
              applicationId: cfg.applicationId, 
              locationId: cfg.locationId, 
              useSandbox: cfg.useSandbox === true 
            };
            squareConfigured = true;
          }
        }
      } catch (e) {
        console.error('Square config check failed:', e);
      }

      if (!squareConfigured) {
        if (squareNotConfigured) squareNotConfigured.style.display = 'block';
        if (squarePaymentContainer) squarePaymentContainer.style.display = 'none';
      } else {
        if (squareNotConfigured) squareNotConfigured.style.display = 'none';
      }

      options.forEach((btn) => {
        btn.addEventListener('click', async () => {
          options.forEach((b) => b.classList.remove('selected'));
          btn.classList.add('selected');
          selectedPackage = {
            name: btn.dataset.name,
            sessions: parseInt(btn.dataset.sessions, 10),
            amount: parseInt(btn.dataset.amount, 10),
            display: btn.dataset.display
          };
          if (summary && summaryName && summaryAmount) {
            summary.style.display = 'block';
            summaryName.textContent = selectedPackage.name;
            summaryAmount.textContent = selectedPackage.display;
          }
          if (squareConfigured && squarePaymentContainer) {
            squarePaymentContainer.style.display = 'block';
            if (squarePaymentSuccess) squarePaymentSuccess.style.display = 'none';
            if (squareNotConfigured) squareNotConfigured.style.display = 'none';
            if (squarePayBtn) squarePayBtn.disabled = true;
            try {
              await initSquareCard();
              if (squarePayBtn) squarePayBtn.disabled = false;
            } catch (e) {
              console.error('Square card init failed:', e);
              if (squarePayBtn) squarePayBtn.disabled = false;
              // Show error message
              if (squareNotConfigured) {
                squareNotConfigured.style.display = 'block';
                squareNotConfigured.innerHTML = '<p style="margin: 0; color: #d32f2f;">Failed to load payment form. Please refresh the page.</p>';
              }
            }
          } else if (!squareConfigured) {
            // Re-check configuration when package is selected
            try {
              const r = await fetch('/api/square');
              if (r.ok) {
                const cfg = await r.json();
                if (cfg && (cfg.configured === true || (cfg.applicationId && cfg.locationId))) {
                  squareCfg = { 
                    applicationId: cfg.applicationId, 
                    locationId: cfg.locationId, 
                    useSandbox: cfg.useSandbox === true 
                  };
                  squareConfigured = true;
                  if (squareNotConfigured) squareNotConfigured.style.display = 'none';
                  if (squarePaymentContainer) {
                    squarePaymentContainer.style.display = 'block';
                    if (squarePayBtn) squarePayBtn.disabled = true;
                    await initSquareCard();
                    if (squarePayBtn) squarePayBtn.disabled = false;
                  }
                }
              }
            } catch (e) {
              console.error('Square re-check failed:', e);
            }
          }
        });
      });

      if (squarePayBtn && squareConfigured) {
        squarePayBtn.addEventListener('click', async () => {
          if (!selectedPackage || !squareCardInstance || !currentClientId) return;
          squarePayBtn.disabled = true;
          try {
            const amountStr = (selectedPackage.amount / 100).toFixed(2);
            const verificationDetails = {
              amount: amountStr,
              currencyCode: 'USD',
              intent: 'CHARGE',
              customerInitiated: true,
              sellerKeyedIn: false,
              billingContact: {
                givenName: (currentClient && currentClient.name) ? currentClient.name.split(' ')[0] : 'Parent',
                familyName: (currentClient && currentClient.name) ? currentClient.name.split(' ').slice(1).join(' ') || 'Guardian' : 'Guardian',
                countryCode: 'US'
              }
            };
            const tokenResult = await squareCardInstance.tokenize(verificationDetails);
            if (tokenResult.status !== 'OK') {
              throw new Error(tokenResult.errors ? JSON.stringify(tokenResult.errors) : 'Card tokenization failed');
            }
            const sourceId = tokenResult.token;
            const body = {
              sourceId,
              amount: selectedPackage.amount,
              idempotencyKey: window.crypto && window.crypto.randomUUID ? window.crypto.randomUUID() : 'pk-' + Date.now() + '-' + Math.random().toString(36).slice(2),
              clientId: currentClientId,
              clientName: (currentClient && currentClient.name) || '',
              packageName: selectedPackage.name,
              sessionCount: selectedPackage.sessions
            };
            const payRes = await fetch('/api/square', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(body)
            });
            const data = payRes.ok ? await payRes.json() : await payRes.json().catch(() => ({}));
            if (!payRes.ok) {
              throw new Error(data.error || data.message || 'Payment failed');
            }
            if (squarePaymentContainer) squarePaymentContainer.style.display = 'none';
            if (summary) summary.style.display = 'none';
            options.forEach((b) => b.classList.remove('selected'));
            selectedPackage = null;
            if (squarePaymentSuccess) squarePaymentSuccess.style.display = 'block';
          } catch (e) {
            console.error('Square payment error:', e);
            alert(e.message || 'Payment could not be completed. Please try again.');
          } finally {
            squarePayBtn.disabled = false;
          }
        });
      }
    }

    function showSessionExpiredState() {
      sessionStorage.removeItem('epc_secure_session_v1_parent');
      const main = document.querySelector('.parent-view-content');
      if (main) {
        main.innerHTML = `
          <div class="parent-info-card" style="text-align: center; max-width: 480px; margin: 40px auto;">
            <h3 style="margin-bottom: 16px;">Session expired or client data unavailable</h3>
            <p style="color: var(--epc-ink-dim); margin-bottom: 24px;">This device may not have the client data, or your session has expired. Please log in again from the device where you registered.</p>
            <a href="parent-portal.html" class="btn-primary" style="display: inline-block; text-decoration: none; text-align: center;">Log in again</a>
          </div>
        `;
      }
    }

    async function loadClientData() {
      try {
        currentClient = await getClient(currentClientId);
        if (!currentClient) {
          showSessionExpiredState();
          return false;
        }

        document.getElementById('clientNameTitle').textContent = currentClient.name;

        const infoGrid = document.getElementById('clientInfoGrid');
        infoGrid.innerHTML = `
          <div class="info-item">
            <span class="info-label">Age</span>
            <span class="info-value">${currentClient.age || 'N/A'}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Primary Trainer</span>
            <span class="info-value">${currentClient.primaryTrainer || 'N/A'}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Parent Contact</span>
            <span class="info-value">${currentClient.parentContact || 'N/A'}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Emergency Contact</span>
            <span class="info-value">${currentClient.emergencyContact || 'N/A'}</span>
          </div>
        `;

        const total = currentClient.packageTotalSessions != null ? currentClient.packageTotalSessions : null;
        const used = currentClient.packageUsedSessions != null ? currentClient.packageUsedSessions : 0;
        const remaining = currentClient.packageRemainingSessions != null ? currentClient.packageRemainingSessions : (total != null ? total - used : null);
        const packageGrid = document.getElementById('parentPackageGrid');
        if (packageGrid) {
          packageGrid.innerHTML = `
            <div class="info-item">
              <span class="info-label">Package</span>
              <span class="info-value">${currentClient.packageName || 'Not set'}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Total Sessions</span>
              <span class="info-value">${total != null ? total : '--'}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Sessions Remaining</span>
              <span class="info-value">${remaining != null ? remaining : '--'}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Sessions Used</span>
              <span class="info-value">${used}</span>
            </div>
          `;
        }

        return true;
      } catch (error) {
        console.error('Error loading client:', error);
        showSessionExpiredState();
        return false;
      }
    }

    async function loadAssessments() {
      try {
        const assessments = await getClientAssessments(currentClientId);
        const container = document.getElementById('parentAssessmentHistory');

        if (!assessments || assessments.length === 0) {
          container.innerHTML = '<p style="color: var(--epc-ink-dim);">No assessments recorded yet.</p>';
          return;
        }

        container.innerHTML = assessments.map((assessment, idx) => {
          const date = new Date(assessment.date).toLocaleDateString();
          return `
            <div style="border-bottom: 1px solid var(--epc-line); padding: 20px 0; ${idx === assessments.length - 1 ? 'border-bottom: none;' : ''}">
              <h4 style="color: var(--epc-gold); margin-bottom: 12px;">Assessment ${idx + 1} - ${date}</h4>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; font-size: 13px;">
                ${assessment.proteusScore ? `<div><strong>Proteus Score:</strong> ${assessment.proteusScore}</div>` : ''}
                ${assessment.powerOutput ? `<div><strong>Power Output:</strong> ${assessment.powerOutput}</div>` : ''}
                ${assessment.speed ? `<div><strong>Speed:</strong> ${assessment.speed}</div>` : ''}
                ${assessment.overheadSquat ? `<div><strong>Overhead Squat:</strong> ${assessment.overheadSquat}</div>` : ''}
                ${assessment.shoulderMobility ? `<div><strong>Shoulder Mobility:</strong> ${assessment.shoulderMobility}</div>` : ''}
                ${assessment.hamstringMobility ? `<div><strong>Hamstring Mobility:</strong> ${assessment.hamstringMobility}</div>` : ''}
                ${assessment.pushupAssessment ? `<div><strong>Push-up Assessment:</strong> ${assessment.pushupAssessment}</div>` : ''}
              </div>
            </div>
          `;
        }).join('');
      } catch (error) {
        console.error('Error loading assessments:', error);
        document.getElementById('parentAssessmentHistory').innerHTML = '<p style="color: #d32f2f;">Error loading assessments.</p>';
      }
    }

    async function loadPrograms() {
      try {
        const programs = await getClientPrograms(currentClientId);
        const container = document.getElementById('parentPrograms');

        if (!programs || programs.length === 0) {
          container.innerHTML = '<p style="color: var(--epc-ink-dim);">No programs created yet.</p>';
          return;
        }

        container.innerHTML = programs.map((program, idx) => {
          const date = new Date(program.createdAt).toLocaleDateString();
          const exercises = program.exercises || [];
          return `
            <div style="border-bottom: 1px solid var(--epc-line); padding: 20px 0; ${idx === programs.length - 1 ? 'border-bottom: none;' : ''}">
              <h4 style="color: var(--epc-gold); margin-bottom: 12px;">Week ${program.week} - ${date}</h4>
              ${exercises.length > 0 ? `
                <ul style="list-style: none; padding: 0; margin: 0;">
                  ${exercises.map(ex => `<li style="padding: 8px 0; border-bottom: 1px solid rgba(201, 178, 127, 0.1);">
                    <strong>${ex.name}</strong>${ex.sets ? ` - ${ex.sets} sets x ${ex.reps || 'N/A'} reps` : ''}${ex.notes ? `<br><small style="color: var(--epc-ink-dim);">${ex.notes}</small>` : ''}
                  </li>`).join('')}
                </ul>
              ` : '<p style="color: var(--epc-ink-dim);">No exercises in this program.</p>'}
            </div>
          `;
        }).join('');
      } catch (error) {
        console.error('Error loading programs:', error);
        document.getElementById('parentPrograms').innerHTML = '<p style="color: #d32f2f;">Error loading programs.</p>';
      }
    }

    async function loadNotes() {
      try {
        const notes = await getClientNotes(currentClientId);
        const container = document.getElementById('parentNotes');

        if (!notes || notes.length === 0) {
          container.innerHTML = '<p style="color: var(--epc-ink-dim);">No progress notes recorded yet.</p>';
          return;
        }

        container.innerHTML = notes.map((note, idx) => {
          const date = new Date(note.date).toLocaleDateString();
          return `
            <div style="border-bottom: 1px solid var(--epc-line); padding: 20px 0; ${idx === notes.length - 1 ? 'border-bottom: none;' : ''}">
              <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                <strong style="color: var(--epc-gold);">${date}</strong>
              </div>
              <p style="color: var(--epc-ink); line-height: 1.6; margin: 0;">${note.note}</p>
            </div>
          `;
        }).join('');
      } catch (error) {
        console.error('Error loading notes:', error);
        document.getElementById('parentNotes').innerHTML = '<p style="color: #d32f2f;">Error loading notes.</p>';
      }
    }

    async function loadPTNotes() {
      try {
        const ptNotes = await getClientPTNotes(currentClientId);
        const container = document.getElementById('parentPTNotes');

        if (!ptNotes || ptNotes.length === 0) {
          container.innerHTML = '<p style="color: var(--epc-ink-dim);">No PT coordination notes recorded yet.</p>';
          return;
        }

        container.innerHTML = ptNotes.map((note, idx) => {
          const date = new Date(note.date).toLocaleDateString();
          return `
            <div style="border-bottom: 1px solid var(--epc-line); padding: 20px 0; ${idx === ptNotes.length - 1 ? 'border-bottom: none;' : ''}">
              <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                <strong style="color: var(--epc-gold);">${date}</strong>
              </div>
              <p style="color: var(--epc-ink); line-height: 1.6; margin: 0;">${note.note}</p>
            </div>
          `;
        }).join('');
      } catch (error) {
        console.error('Error loading PT notes:', error);
        document.getElementById('parentPTNotes').innerHTML = '<p style="color: #d32f2f;">Error loading PT notes.</p>';
      }
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initParentView);
    } else {
      initParentView();
    }
  </script>
</body>
</html>
